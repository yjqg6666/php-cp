sudo: required

language: c

matrix:
    include:
        - os: osx
          env:
              - PHP_VERSION_MAJOR: "71"
        - os: osx
          env:
              - PHP_VERSION_MAJOR: "70"
        - os: osx
          env:
              - PHP_VERSION_MAJOR: "56"
        - os: osx
          env:
              - PHP_VERSION_MAJOR: "55"
        - os: osx
          env:
              - PHP_VERSION_MAJOR: "54"
        - os: osx
          env:
              - PHP_VERSION_MAJOR: "53"

services:
    - mysql
    - redis-server

before_install:
    - export CP_PATH=`pwd`
    - brew update
    - brew tap homebrew/dupes 1>/dev/null && brew tap homebrew/versions 1>/dev/null && brew tap homebrew/homebrew-php 1>/dev/null
    - brew install homebrew/php/php${PHP_VERSION_MAJOR} --with-pear
    #- export PHP_BUILD_CONF="--with-libedit --with-pear --enable-fpm --enable-mbstring --with-pcre-dir --enable-mysqlnd --enable-pdo --with-pdo-mysql --with-openssl --with-curl --enable-zip --enable-sockets --enable-bcmath --enable-calendar --enable-ftp --disable-intl --enable-mbstring --enable-pcntl"
    - export PHP_PATH=$(brew --prefix php${PHP_VERSION_MAJOR})
    - export PHP_BIN_DIR=$(brew --prefix php${PHP_VERSION_MAJOR})/bin
    - export PATH="${PHP_BIN_DIR}:${PATH}"
    - export PHP_BIN=${PHP_BIN_DIR}/php
    - export PHP_CONF_DIR=$(${PHP_BIN} --ini|grep 'Scan'|cut -d":" -f2|tr -d " ")
    - export REDIS_VERSION_INSTALL=3.1.1

install:
    - sudo mkdir -m 777 /var/log/php-connection-pool
    - echo "${PHP_CONF_DIR}"
    - if [ ! -d "${PHP_CONF_DIR}" ]; then sudo mkdir -m 777 "${PHP_CONF_DIR}"; fi
    - chmod +x ${CP_PATH}/pool_server
    - sudo cp ${CP_PATH}/pool_server /usr/local/bin/pool_server
    - sudo cp ${CP_PATH}/config.ini.example /etc/pool.ini
    - ${CP_PATH}/.travis/php_install_ext.sh "${CP_PATH}" "${PHP_PATH}"
    - echo 'extension = connect_pool.so' > ${PHP_CONF_DIR}/connect_pool.ini
    - git clone -b ${REDIS_VERSION_INSTALL} https://github.com/phpredis/phpredis.git && ${CP_PATH}/.travis/php_install_ext.sh "${CP_PATH}/phpredis" "${PHP_PATH}" && echo 'extension = redis.so' > ${PHP_CONF_DIR}/redis.ini

before_script:
    - $PHP_BIN -m
    - $PHP_BIN -m | grep -s connect_pool
    - $PHP_BIN -m | grep -s redis
    - sudo touch /var/run/php_connection_pool.pid && sudo chmod 777 /var/run/php_connection_pool.pid
    - ${CP_PATH}/pool_server start
    - mysql -uroot -e "CREATE DATABASE IF NOT EXISTS test"
    - mysql -uroot test < ${CP_PATH}/.travis/test.sql
    - mysql -uroot -e "SET PASSWORD = PASSWORD('password')"

script:
    - netstat -tlnp |grep 6253
    - ${CP_PATH}/pool_server status
    - env TEST_PHP_EXECUTABLE=$PHP_BIN $PHP_BIN "${PHP_PATH}/run-tests.php" -c "${PHP_PATH}/config/php.ini" --show-diff "${CP_PATH}/tests" |tee /tmp/php_cp_test.result && fail_num=$(grep -o -E "Tests\s+failed\s*:\s*[0-9]{1,}\s*\(" /tmp/php_cp_test.result |grep -o -E "[0-9]{1,}" -) && fail_num=$((fail_num+0)) && echo $fail_num && [ $fail_num -eq 0 ]

after_success: true

after_failure: true

after_script: true

notifications:
    email:
        recipients:
            - jinking.this@gmail.com
            #- 83212019@qq.com
        on_success: change
        on_failure: always
